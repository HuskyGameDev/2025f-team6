using System.Collections;
using TMPro;
using UnityEngine;
using UnityEngine.Animations;
using UnityEngine.SceneManagement;
using UnityEngine.UI;

public class PlayerCollision : MonoBehaviour
{
    [Header("Collision Effects")]
    [SerializeField] private ParticleSystem collisionParticle;
    [SerializeField] private AudioClip collisionSound;
    [SerializeField] private float shakeDuration = 0.2f;
    [SerializeField] private float shakeMagnitude = 0.1f;

    [Header("Player Effects")]
    [SerializeField] private SpriteRenderer playerSprite;
    [SerializeField] private Color damageColor = Color.red;
    [SerializeField] private float flashDuration = 0.3f;
    [SerializeField] private float immunityTime = 1.0f;
    [SerializeField] private Collider2D playerHitbox;
    [SerializeField] private PlayerControl pc;
    [SerializeField] private int lives = 3;
    [SerializeField] private string endScene;


    private GameObject heartA; // left-most
    private GameObject heartB;
    private GameObject heartC;

    private AudioSource audioSource;
    private Color originalColor;
    private Vector3 shakeStartPosition;

    void Start()
    {
        audioSource = GetComponent<AudioSource>();
        pc = GetComponent<PlayerControl>();
        if (audioSource == null)
        {
            audioSource = gameObject.AddComponent<AudioSource>();
        }

        if (playerSprite != null)
        {
            originalColor = playerSprite.color;
        }

        // find the hearts
        GameObject[] heartArr = GameObject.FindGameObjectsWithTag("Hearts");
        foreach (GameObject heart in heartArr)
        {
            if (heart.name == "HeartA")
                heartA = heart;
            else if (heart.name == "HeartB")
                heartB = heart;
            else if (heart.name == "HeartC")
                heartC = heart;
        }
    }

    private void OnTriggerEnter2D(Collider2D other)
    {
        if (other.CompareTag("Obstacle"))
        {
            HandleCollision(other.gameObject);
        }
    }

    private void OnCollisionEnter2D(Collision2D collision)
    {
        if (collision.gameObject.CompareTag("Obstacle"))
        {
            HandleCollision(collision.gameObject);
        }
    }

    public void HandleCollision(GameObject obstacle)
    {

        //Reduce Lives by 1
        lives--;
        if(lives == 0)
        {
            UIController.setFinalScore(UIController.getFinalScore());
            SceneManager.LoadScene(endScene);
            //Pause the game (put all speeds to 0)
            //Pop up end screen
        }

        // Store current position for screen shake (where player actually is when hit)
        shakeStartPosition = transform.position;

        // Play particle effect
        if (collisionParticle != null)
        {
            Instantiate(collisionParticle, transform.position, Quaternion.identity);
        }

        // Play sound
        if (collisionSound != null && audioSource != null)
        {
            audioSource.PlayOneShot(collisionSound);
        }

        // Screen shake
        StartCoroutine(ScreenShake());

        // Player flash
        StartCoroutine(PlayerFlash());

        // Player flash
        StartCoroutine(IFrames());

        // Note: The obstacle will handle its own deactivation through its ObstacleController
        // We don't destroy it here anymore

        // Add your game logic here (reduce health, game over, etc.)
        OnPlayerHit();
    }

    private IEnumerator ScreenShake()
    {
        float elapsed = 0f;

        while (elapsed < shakeDuration)
        {
            float x = shakeStartPosition.x + Random.Range(-1f, 1f) * shakeMagnitude;
            float y = shakeStartPosition.y + Random.Range(-1f, 1f) * shakeMagnitude;

            transform.position = new Vector3(x, y, shakeStartPosition.z);

            elapsed += Time.deltaTime;
            yield return null;
        }

        // Return to the position where the player was when hit, NOT the original spawn position
        pc.RestartMotion();
    }

    private IEnumerator PlayerFlash()
    {
        if (playerSprite != null)
        {
            playerSprite.color = damageColor;
            yield return new WaitForSeconds(flashDuration);
            playerSprite.color = originalColor;
        }
    }
    private IEnumerator IFrames()
    {
        playerHitbox.enabled = false;
        yield return new WaitForSeconds(immunityTime);
        playerHitbox.enabled = true;
    }

    protected virtual void OnPlayerHit()
    {
        Debug.Log("Player hit by obstacle! " + lives + " lives remain.");

        hideHearts(lives);
    }

    public int getLivesRemaining()
    {
        return lives;
    }

    public void hideHearts(int lives)
    {
        if (heartA == null || heartB == null || heartC == null)
        {
            Debug.LogWarning("Heart sprite(s) not found.");
            return;
        }

        // Hide based on remaining lives (called from PlayerCollision)
        if (lives == 2) // first hit
        {
            heartC.SetActive(false);
        }
        if (lives == 1) // second hit
        {
            heartB.SetActive(false);
        }
        if (lives <= 0) // perish
        {
            heartA.SetActive(false);
        }

            // Ensure the others are also hidden if lives <= 0
            //if (heartB != null) heartB.SetActive(false);
            //if (heartC != null) heartC.SetActive(false);
    }

    public void showAllHearts()
    {
        if (heartA == null || heartB == null || heartC == null)
        {
            Debug.LogWarning("Heart sprite(s) not found.");
            return;
        }

        // Show all hearts
        if (heartA != null) heartA.SetActive(true);
        if (heartB != null) heartB.SetActive(true);
        if (heartC != null) heartC.SetActive(true);
    }
}